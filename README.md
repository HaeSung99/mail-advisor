# Mail Advisor

AI 기반 네이버 메일 작성 어시스턴트 - 실시간 메일 본문 분석 및 전문적 재작성 서비스

## 개요

Mail Advisor는 네이버 메일에서 작성 중인 메일을 실시간으로 분석하여, 사용자의 직책, 업무, 목적에 맞게 전문적인 메일로 재작성해주는 Chrome 확장 프로그램입니다. OpenAI GPT를 활용한 지능형 프롬프트 엔지니어링으로 문법 교정부터 톤앤매너 조정, 설득력 강화까지 종합적인 메일 작성 지원을 제공합니다.

## 핵심 특징

### AI 기반 메일 재작성 시스템

이 서비스는 OpenAI GPT-5-nano 모델을 활용하며, 단순 API 호출이 아닌 정교한 프롬프트 엔지니어링을 통해 작동합니다.

#### 프롬프트 설계
- **500줄 분량의 상세 지시문**: 메일 작성의 모든 측면을 제어하는 체계적인 instruction 구성
- **역할 정의**: AI가 "적극적인 이메일 파트너" 역할을 수행하도록 명확히 정의
- **출력 제약**: 불필요한 설명 제거, 본문만 반환하도록 엄격히 제한
- **언어 유지**: 원문의 언어(한국어/영어)를 자동으로 감지하여 유지
- **사실 보존**: 사용자가 제공하지 않은 정보(날짜, 이름, 수치)는 절대 창작하지 않음

#### 컨텍스트 인식 재작성
사용자가 제공하는 8가지 컨텍스트 변수를 기반으로 메일을 재구성합니다:

1. **직책 (my_position)**: 매니저, 이사, CEO, 팀장, 시니어, 주니어 등
2. **업무 분야 (my_job)**: 마케팅, 영업, HR, 재무, IT, 디자인 등
3. **톤앤매너 (tone_level)**: 정중한, 친근한, 설득력 있는, 긴급한 등 6가지 스타일
4. **메일 목표 (my_goal)**: 제안서, 회의 요청, 피드백, 승인 요청, 사과 등 8가지
5. **수신자 타입 (audience)**: 고객, 상사, 동료, 투자자 등 8가지
6. **길이 정책 (text_length)**: 짧게, 길게, 유사하게, 최적화(자동)
7. **추가 가이드 (guide)**: 사용자의 자유 입력 (선택)
8. **작업 유형 (task_type)**: 추가 세부 작업 분류 (선택)

#### 동작 흐름
```
사용자 입력 → 컨텍스트 수집 → GPT API 호출 (instruction + 원문)
→ 응답 후처리 (sanitize) → 마크다운 제거 → 순수 본문만 반환
→ 실제 토큰 사용량 계산 → DB 차감 → 결과 표시
```

#### 예시
**입력 (사용자 초안)**
```
안녕하세요. 다음주 목요일에 회의 가능하신지 알고 싶습니다.
```

**컨텍스트 설정**
- 직책: 시니어 (senior)
- 업무: 마케팅 (marketing)
- 톤: 정중한 (formal)
- 목표: 회의 요청 (meeting)
- 대상: 상사 (boss)
- 길이: 최적화 (optimized)

**출력 (AI 재작성)**
```
안녕하세요.

다음 주 목요일 회의 일정에 대해 협의드리고자 합니다.
가능하신 시간대를 공유해 주시면 일정을 조율하겠습니다.

감사합니다.
```

### 실시간 동기화
- iframe 내부 네이버 메일 에디터 실시간 감지
- Shadow DOM 기반 독립적 UI (네이버 메일 스타일 비간섭)

### 즉시 적용 기능
- AI 재작성 결과를 원본 에디터에 원클릭 적용
- 되돌리기 버튼으로 이전 내용으로 복구 가능

### 토큰 기반 과금
- OpenAI 실제 사용량 기반 차감 (요청 토큰 + 응답 토큰)
- 토스페이먼츠 연동 충전 시스템

## 주요 기능

### 사용자 관리
- JWT 기반 회원가입 / 로그인
- Access Token (2시간) + Refresh Token (1일) 자동 갱신
- 토큰 잔액 실시간 표시

### 프로필 설정
- 8가지 직책 옵션 + 직접 입력
- 8가지 업무 분야 + 직접 입력
- 설정값은 모든 메일 작성에 자동 적용

### 메일 커스터마이징
- 6가지 톤앤매너 프리셋 + 직접 입력
- 8가지 메일 목표 타입 + 직접 입력
- 8가지 수신자 타입 + 직접 입력
- 4가지 길이 정책

### 결제 시스템 (예시)
- 3천원 / 5천원 / 1만원 / 5만원 패키지
- 테스트 환경 지원 (실제 결제 없이 테스트 가능)
- 결제 내역 저장 및 조회

## 사용 가이드

### 1. 초기 설정

#### 백엔드 서버 실행
```bash
# 저장소 클론
git clone <repository-url>
cd mail-advisor/mail-advisor-back

# 환경변수 설정 (sample.env 템플릿을 .env로 복사 후 환경변수 적용)
cp sample.env .env

# Docker로 실행 (MySQL + NestJS)
docker-compose up -d --build
```

서버는 `http://localhost:3000`에서 실행됩니다.

#### Chrome 확장 프로그램 설치 및 사용 방법
```bash
1. Chrome 주소창에 chrome://extensions 입력
2. 우측 상단 "개발자 모드" 토글 활성화
3. 좌측 "압축해제된 확장 프로그램을 로드합니다" 클릭
4. mail-advisor-front 폴더 선택
5. "메일 어드바이저" 확장 프로그램 추가 확인
```

### 2. 회원가입 및 로그인

```bash
1. https://mail.naver.com 접속
2. 메일 쓰기 버튼 클릭 (또는 기존 메일 작성 화면)
3. Chrome 툴바에서 "메일 어드바이저" 아이콘 클릭
4. 우측 사이드 패널이 열림
5. 회원가입 탭에서 사용자명/비밀번호 입력 후 "회원가입" 클릭
   (또는 기존 계정으로 로그인)
```

로그인 성공 시 토큰 잔액이 표시됩니다 (초기 1만 토큰).

### 3. 메일 작성 및 AI 조언 받기

#### 3.1 프로필 설정
```
[프로필 설정] 섹션
- 직책: 예) "시니어"
- 업무: 예) "마케팅"
```

이 설정은 언제든 변경 가능합니다.

#### 3.2 메일 초안 작성
네이버 메일 에디터에 평소처럼 메일을 작성합니다.

```
예시:
안녕하세요. 
이번 프로젝트 관련해서 회의가 필요할 것 같습니다.
다음주에 시간 괜찮으신가요?
```

#### 3.3 메일 구성 설정
```
[메일 구성] 섹션
- 톤앤매너: "정중하고 전문적인" 선택
- 목표: "회의 요청" 선택
- 길이: "최적화 (추천)" 선택
- 대상: "상사" 선택
```

#### 3.4 AI 조언 받기
```
1. "AI 조언 받기" 버튼 클릭
2. 2-5초 대기 (AI 분석 중)
3. [AI 조언] 섹션에 재작성된 메일 표시
4. "245 토큰 사용 (남은 토큰: 9755)" 확인
```

#### 3.5 결과 적용
```
방법 1: 직접 복사
- AI 조언 내용을 복사하여 에디터에 수동으로 붙여넣기

방법 2: 원클릭 적용 (권장)
- "적용하기" 버튼 클릭
- 에디터의 내용이 AI 재작성 결과로 자동 교체
- 원본은 자동 백업됨
- "되돌리기" 버튼으로 언제든 복구 가능
```

### 4. 토큰 충전 (예시)

```
1. 패널 상단 [보유 중] 카드에서 "토큰 충전하기" 클릭
2. 금액 선택 모달에서 원하는 금액 선택
   - 3천원 (3,000 토큰)
   - 5천원 (5,000 토큰)
   - 1만원 (10,000 토큰)
   - 5만원 (50,000 토큰)
3. 확인 버튼 클릭
4. 결제 처리 대기 (테스트 환경: 자동 승인)
5. "충전 완료!" 알림 확인
6. 토큰 잔액 업데이트 확인
```

### 5. 고급 사용법

#### 직접 입력 옵션
모든 선택 항목에서 "직접 입력"을 선택하면 커스텀 값을 입력할 수 있습니다.

```
예시:
톤앤매너: "직접 입력" 선택
입력창: "따뜻하면서도 전문적이고 긴급함을 강조" 입력 (최대 50자)

목표: "직접 입력" 선택  
입력창: "예산 증액을 설득력있게 요청" 입력 (최대 100자)
```

#### 여러 버전 비교
```
1. 첫 번째 조언 받기 (예: 톤앤매너 "정중한")
2. 결과를 별도 메모장에 복사
3. 설정 변경 (예: 톤앤매너 "설득력 있는")
4. 두 번째 조언 받기
5. 두 결과를 비교하여 최적의 버전 선택
```

## 기술 스택

### Frontend
- Vanilla JavaScript (ES6+)
- Shadow DOM (CSS 격리)
- Chrome Extension Manifest V3
- MutationObserver (DOM 변화 감지)

### Backend
- NestJS (TypeScript)
- TypeORM (MySQL 8.0)
- OpenAI API (GPT-5-nano 모델) // 테스트용 으로 저렴한 모델 선택
- JWT Authentication
- Toss Payments Key-in API

## 설치 및 실행

### 시스템 요구사항
- Node.js 18 이상
- Docker & Docker Compose
- Chrome 브라우저 (Manifest V3 지원)
- OpenAI API Key (필수)
- Toss Payments 개발자 계정 (결제 기능 사용 시)

## 환경변수 설명

### 필수 환경변수

| 변수명 | 설명 |
|--------|------|
| `OPENAI_API_KEY` | OpenAI API 키 | 
| `JWT_SECRET` | JWT 서명용 시크릿 |
| `DB_PASSWORD` | MySQL 사용자 비밀번호 |
| `MYSQL_ROOT_PASSWORD` | MySQL Root 비밀번호 |
| `DB_HOST` | MySQL 호스트 |
| `DB_USERNAME` | MySQL 사용자명 |
| `DB_DATABASE` | 데이터베이스 이름 |

### 선택 환경변수 (결제 기능)

| 변수명 | 설명 |
|--------|------|
| `TOSS_CLIENT_KEY` | 토스페이먼츠 클라이언트 키 |
| `TOSS_SECRET_KEY` | 토스페이먼츠 시크릿 키 |

자세한 내용은 `mail-advisor-back/PAYMENT_SETUP.md` 참조

## 프로젝트 구조

```
mail-advisor/
├── mail-advisor-back/          # NestJS 백엔드
│   ├── src/
│   │   ├── advisor/           # AI 메일 재작성 서비스
│   │   │   ├── advisor.service.ts   (프롬프트 엔지니어링)
│   │   │   └── advisor.controller.ts
│   │   ├── auth/              # 인증 및 사용자 관리
│   │   │   ├── auth.service.ts      (JWT 발급/검증)
│   │   │   ├── user.entity.ts       (사용자 DB 모델)
│   │   │   └── user.repository.ts   (토큰 잔액 관리)
│   │   ├── payment/           # 결제 처리
│   │   │   ├── payment.service.ts   (토스페이먼츠 연동)
│   │   │   └── payment.entity.ts    (결제 내역 DB)
│   │   └── app.module.ts      # 루트 모듈
│   ├── docker-compose.yml     # Docker 구성
│   ├── Dockerfile
│   └── sample.env             # 환경변수 템플릿
│
├── mail-advisor-front/         # Chrome Extension
│   ├── manifest.json          # 확장 프로그램 설정
│   ├── content.js             # 메인 로직 (1168줄)
│   ├── background.js          # 백그라운드 서비스 워커
│   ├── panel.html             # 사이드 패널 UI
│   └── panel.css              # 스타일시트
│
└── README.md
```

## API 엔드포인트

### 인증
- `POST /auth/signup` - 회원가입
- `POST /auth/login` - 로그인 (Access Token + Refresh Token 발급)
- `POST /auth/refresh` - Access Token 갱신
- `POST /auth/token-balance` - 토큰 잔액 조회

### AI 메일 작성
- `POST /advisor` - 메일 재작성 (Authorization 헤더 필요)

### 결제
- `POST /payment/confirm` - 토큰 충전
- `GET /payment/history` - 결제 내역 조회

## 라이선스

이 프로젝트는 비공개 소프트웨어입니다.
